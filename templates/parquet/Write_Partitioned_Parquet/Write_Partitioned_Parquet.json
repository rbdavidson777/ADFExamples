{"$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"factoryName":{"type":"string","metadata":"Data Factory name"},"AzureDataLakeStorage1":{"type":"string"}},"variables":{"factoryId":"[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"},"resources":[{"name":"[concat(parameters('factoryName'), '/Write_Partitioned_Parquet')]","type":"Microsoft.DataFactory/factories/pipelines","apiVersion":"2018-06-01","properties":{"activities":[{"name":"Write_Partitioned_Parquet","type":"ExecuteDataFlow","dependsOn":[],"policy":{"timeout":"7.00:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"dataflow":{"referenceName":"Write_Delta_Partitioned","type":"DataFlowReference","parameters":{},"datasetParameters":{"source1":{},"sink1":{}}},"staging":{},"compute":{"coreCount":8,"computeType":"General"},"traceLevel":"Fine"}}],"annotations":[]},"dependsOn":["[concat(variables('factoryId'), '/dataflows/Write_Delta_Partitioned')]"]},{"name":"[concat(parameters('factoryName'), '/Write_Delta_Partitioned')]","type":"Microsoft.DataFactory/factories/dataflows","apiVersion":"2018-06-01","properties":{"type":"MappingDataFlow","typeProperties":{"sources":[{"dataset":{"referenceName":"Taxi_Raw","type":"DatasetReference"},"name":"source1"}],"sinks":[{"dataset":{"referenceName":"Parquet6","type":"DatasetReference"},"name":"sink1"}],"transformations":[{"name":"MapPartitions"}],"script":"source(output(\n\t\tVendorID as string,\n\t\ttpep_pickup_datetime as string,\n\t\ttpep_dropoff_datetime as string,\n\t\tpassenger_count as string,\n\t\ttrip_distance as string,\n\t\tRatecodeID as string,\n\t\tstore_and_fwd_flag as string,\n\t\tPULocationID as string,\n\t\tDOLocationID as string,\n\t\tpayment_type as string,\n\t\tfare_amount as string,\n\t\textra as string,\n\t\tmta_tax as string,\n\t\ttip_amount as string,\n\t\ttolls_amount as string,\n\t\timprovement_surcharge as string,\n\t\ttotal_amount as string,\n\t\tcongestion_surcharge as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> source1\nsource1 derive(year = left(tpep_pickup_datetime,4),\n\t\tmonth = substring(tpep_pickup_datetime,6,2),\n\t\tday = substring(tpep_pickup_datetime,9,2)) ~> MapPartitions\nMapPartitions sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet',\n\tpartitionBy('key',\n\t\t0,\n\t\tyear,\n\t\tmonth,\n\t\tday\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> sink1"}},"dependsOn":["[concat(variables('factoryId'), '/datasets/Taxi_Raw')]","[concat(variables('factoryId'), '/datasets/Parquet6')]"]},{"name":"[concat(parameters('factoryName'), '/Taxi_Raw')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('AzureDataLakeStorage1')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobFSLocation","folderPath":"raw","fileSystem":"delta"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"VendorID","type":"String"},{"name":"tpep_pickup_datetime","type":"String"},{"name":"tpep_dropoff_datetime","type":"String"},{"name":"passenger_count","type":"String"},{"name":"trip_distance","type":"String"},{"name":"RatecodeID","type":"String"},{"name":"store_and_fwd_flag","type":"String"},{"name":"PULocationID","type":"String"},{"name":"DOLocationID","type":"String"},{"name":"payment_type","type":"String"},{"name":"fare_amount","type":"String"},{"name":"extra","type":"String"},{"name":"mta_tax","type":"String"},{"name":"tip_amount","type":"String"},{"name":"tolls_amount","type":"String"},{"name":"improvement_surcharge","type":"String"},{"name":"total_amount","type":"String"},{"name":"congestion_surcharge","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/Parquet6')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('AzureDataLakeStorage1')]","type":"LinkedServiceReference"},"annotations":[],"type":"Parquet","typeProperties":{"location":{"type":"AzureBlobFSLocation","fileSystem":"partitioned-parquet"},"compressionCodec":"snappy"},"schema":[]},"dependsOn":[]}]}